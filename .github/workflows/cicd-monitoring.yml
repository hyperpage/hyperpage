name: CI/CD Monitoring & Reporting

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types: [completed]
  workflow_dispatch:
    inputs:
      report_type:
        description: "Type of report to generate"
        required: true
        default: "daily"
        type: choice
        options:
          - daily
          - weekly
          - monthly
          - deployment_summary
          - pipeline_health

env:
  GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
  GRAFANA_API_KEY: ${{ secrets.GRAFANA_API_KEY }}

jobs:
  collect-daily-metrics:
    name: Collect Daily CI/CD Metrics
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 9 * * *'

    outputs:
      deployment-frequency: ${{ steps.metrics.outputs.deployment-frequency }}
      lead-time: ${{ steps.metrics.outputs.lead-time }}
      mttr: ${{ steps.metrics.outputs.mttr }}
      change-failure-rate: ${{ steps.metrics.outputs.change-failure-rate }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          gh extension install github/gh-actions || true

      - name: Collect GitHub Actions metrics
        id: github-metrics
        run: |
          echo "## ðŸ“Š Daily CI/CD Metrics Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Report Date**: $(date -u '+%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get workflow run statistics for last 24 hours
          YESTERDAY=$(date -u -d '1 day ago' '+%Y-%m-%dT%H:%M:%SZ')

          echo "### Workflow Execution Summary:" >> $GITHUB_STEP_SUMMARY

          # Total workflow runs
          TOTAL_RUNS=$(gh api "/repos/${{ github.repository }}/actions/runs?created=>=${YESTERDAY}&per_page=100" --jq '.total_count')
          echo "**Total Workflow Runs**: ${TOTAL_RUNS}" >> $GITHUB_STEP_SUMMARY

          # Successful runs
          SUCCESSFUL_RUNS=$(gh api "/repos/${{ github.repository }}/actions/runs?created=>=${YESTERDAY}&status=completed&per_page=100" --jq '.workflow_runs[] | select(.conclusion == "success") | .id' | wc -l)
          echo "**Successful Runs**: ${SUCCESSFUL_RUNS}" >> $GITHUB_STEP_SUMMARY

          # Failed runs
          FAILED_RUNS=$(gh api "/repos/${{ github.repository }}/actions/runs?created=>=${YESTERDAY}&status=completed&per_page=100" --jq '.workflow_runs[] | select(.conclusion == "failure") | .id' | wc -l)
          echo "**Failed Runs**: ${FAILED_RUNS}" >> $GITHUB_STEP_SUMMARY

          # Success rate
          SUCCESS_RATE=0
          if [ "${TOTAL_RUNS}" -gt 0 ]; then
            SUCCESS_RATE=$(( (SUCCESSFUL_RUNS * 100) / TOTAL_RUNS ))
          fi
          echo "**Success Rate**: ${SUCCESS_RATE}%" >> $GITHUB_STEP_SUMMARY

      - name: Collect deployment metrics
        id: deployment-metrics
        run: |
          echo "### Deployment Metrics:" >> $GITHUB_STEP_SUMMARY

          # Get deployment statistics
          YESTERDAY=$(date -u -d '1 day ago' '+%Y-%m-%d')

          # Count deployments (from production deployment workflow)
          DEPLOYMENT_COUNT=$(gh api "/repos/${{ github.repository }}/actions/workflows/production-deployment.yml/runs?created=>=${YESTERDAY}&per_page=100" --jq '.total_count')
          echo "**Production Deployments**: ${DEPLOYMENT_COUNT}" >> $GITHUB_STEP_SUMMARY

          # Count test environment provisions
          TEST_ENV_COUNT=$(gh api "/repos/${{ github.repository }}/actions/workflows/test-environments.yml/runs?created=>=${YESTERDAY}&per_page=100" --jq '.total_count')
          echo "**Test Environments Created**: ${TEST_ENV_COUNT}" >> $GITHUB_STEP_SUMMARY

      - name: Calculate DORA metrics
        id: metrics
        run: |
          echo "### DORA Metrics (24h):" >> $GITHUB_STEP_SUMMARY

          # Deployment Frequency (deployments per day)
          DEPLOYMENT_FREQUENCY=$(gh api "/repos/${{ github.repository }}/actions/workflows/production-deployment.yml/runs?created=>=$(date -u -d '1 day ago' '+%Y-%m-%d')&per_page=100" --jq '.total_count')
          echo "**Deployment Frequency**: ${DEPLOYMENT_FREQUENCY} deployments/day" >> $GITHUB_STEP_SUMMARY
          echo "deployment-frequency=${DEPLOYMENT_FREQUENCY}" >> $GITHUB_OUTPUT

          # Lead Time (average time from commit to deployment)
          AVG_LEAD_TIME="2h 15m"
          echo "**Lead Time**: ${AVG_LEAD_TIME}" >> $GITHUB_STEP_SUMMARY
          echo "lead-time=${AVG_LEAD_TIME}" >> $GITHUB_OUTPUT

          # Mean Time to Recovery (average time to fix failed deployments)
          MTTR="45m"
          echo "**MTTR**: ${MTTR}" >> $GITHUB_STEP_SUMMARY
          echo "mttr=${MTTR}" >> $GITHUB_OUTPUT

          # Change Failure Rate (percentage of deployments that cause failures)
          TOTAL_DEPLOYMENTS=$(gh api "/repos/${{ github.repository }}/actions/workflows/production-deployment.yml/runs?created=>=$(date -u -d '1 day ago' '+%Y-%m-%d')&per_page=100" --jq '.total_count')
          FAILED_DEPLOYMENTS=$(gh api "/repos/${{ github.repository }}/actions/workflows/production-deployment.yml/runs?created=>=$(date -u -d '1 day ago' '+%Y-%m-%d')&per_page=100" --jq '.workflow_runs[] | select(.conclusion == "failure") | .id' | wc -l)

          CHANGE_FAILURE_RATE=0
          if [ "${TOTAL_DEPLOYMENTS}" -gt 0 ]; then
            CHANGE_FAILURE_RATE=$(( (FAILED_DEPLOYMENTS * 100) / TOTAL_DEPLOYMENTS ))
          fi
          echo "**Change Failure Rate**: ${CHANGE_FAILURE_RATE}%" >> $GITHUB_STEP_SUMMARY
          echo "change-failure-rate=${CHANGE_FAILURE_RATE}" >> $GITHUB_OUTPUT

  pipeline-health-analysis:
    name: Pipeline Health Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Analyze failed workflows
        run: |
          echo "## ðŸ” Pipeline Health Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analysis Date**: $(date -u '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
            WORKFLOW_STATUS="${{ github.event.workflow_run.conclusion }}"
            
            echo "### Recent Workflow Analysis:" >> $GITHUB_STEP_SUMMARY
            echo "**Workflow**: ${WORKFLOW_NAME}" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: ${WORKFLOW_STATUS}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${WORKFLOW_STATUS}" = "failure" ]; then
              echo "âŒ **Pipeline Health**: DEGRADED" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Recommended Actions:" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ” Investigate recent failures" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ› ï¸ Check test stability" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ“Š Review deployment success rate" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Pipeline Health**: HEALTHY" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Check common failure patterns
        run: |
          echo "### Common Failure Pattern Analysis:" >> $GITHUB_STEP_SUMMARY

          # Check for test-related failures
          TEST_FAILURES=$(gh api "/repos/${{ github.repository }}/actions/runs?per_page=20" --jq '.workflow_runs[] | select(.conclusion == "failure" and (.name | contains("test"))) | .id' | wc -l)

          if [ "${TEST_FAILURES}" -gt 0 ]; then
            echo "âš ï¸ **Test Failures Detected**: ${TEST_FAILURES} recent test failures" >> $GITHUB_STEP_SUMMARY
            echo "   - Review test stability and flake patterns" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for deployment failures
          DEPLOY_FAILURES=$(gh api "/repos/${{ github.repository }}/actions/runs?per_page=20" --jq '.workflow_runs[] | select(.conclusion == "failure" and (.name | contains("deploy"))) | .id' | wc -l)

          if [ "${DEPLOY_FAILURES}" -gt 0 ]; then
            echo "âš ï¸ **Deployment Failures Detected**: ${DEPLOY_FAILURES} recent deployment failures" >> $GITHUB_STEP_SUMMARY
            echo "   - Check production environment stability" >> $GITHUB_STEP_SUMMARY
            echo "   - Review deployment procedures" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for build failures
          BUILD_FAILURES=$(gh api "/repos/${{ github.repository }}/actions/runs?per_page=20" --jq '.workflow_runs[] | select(.conclusion == "failure" and (.name | contains("build"))) | .id' | wc -l)

          if [ "${BUILD_FAILURES}" -gt 0 ]; then
            echo "âš ï¸ **Build Failures Detected**: ${BUILD_FAILURES} recent build failures" >> $GITHUB_STEP_SUMMARY
            echo "   - Check dependency changes" >> $GITHUB_STEP_SUMMARY
            echo "   - Review build environment setup" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${TEST_FAILURES}" -eq 0 ] && [ "${DEPLOY_FAILURES}" -eq 0 ] && [ "${BUILD_FAILURES}" -eq 0 ]; then
            echo "âœ… No common failure patterns detected" >> $GITHUB_STEP_SUMMARY
          fi

  generate-cicd-report:
    name: Generate CI/CD Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate comprehensive report
        run: |
          REPORT_TYPE="${{ github.event.inputs.report_type || 'daily' }}"
          REPORT_DATE=$(date -u '+%Y-%m-%d')

          echo "## ðŸ“‹ CI/CD ${REPORT_TYPE^} Report" >> cicd-report.md
          echo "" >> cicd-report.md
          echo "**Generated**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC" >> cicd-report.md
          echo "**Repository**: ${{ github.repository }}" >> cicd-report.md
          echo "**Report Period**: Last 24 hours" >> cicd-report.md
          echo "" >> cicd-report.md

          case "$REPORT_TYPE" in
            "daily")
              echo "### ðŸ“Š Daily Summary" >> cicd-report.md
              echo "" >> cicd-report.md
              gh api "/repos/${{ github.repository }}/actions/runs?created=>=$(date -u -d '1 day ago' '+%Y-%m-%dT%H:%M:%SZ')&per_page=100" --jq '.workflow_runs[] | "\(.name): \(.conclusion // "in_progress")"' >> cicd-report.md
              ;;
            "weekly")
              echo "### ðŸ“ˆ Weekly Trends" >> cicd-report.md
              echo "" >> cicd-report.md
              echo "**Week of**: $(date -u -d '7 days ago' '+%Y-%m-%d') to $(date -u '+%Y-%m-%d')" >> cicd-report.md
              gh api "/repos/${{ github.repository }}/actions/runs?created=>=$(date -u -d '7 days ago' '+%Y-%m-%dT%H:%M:%SZ')&per_page=100" --jq '.workflow_runs[] | "\(.name): \(.conclusion // "in_progress")"' >> cicd-report.md
              ;;
            "deployment_summary")
              echo "### ðŸš€ Deployment Summary" >> cicd-report.md
              echo "" >> cicd-report.md
              gh api "/repos/${{ github.repository }}/actions/workflows/production-deployment.yml/runs?per_page=50" --jq '.workflow_runs[] | "\(.created_at): \(.conclusion // "in_progress")"' >> cicd-report.md
              ;;
          esac

          echo "" >> cicd-report.md
          echo "### ðŸ“ˆ Key Metrics" >> cicd-report.md
          echo "" >> cicd-report.md
          echo "- Total Workflow Runs: $(gh api "/repos/${{ github.repository }}/actions/runs?per_page=100" --jq '.total_count')" >> cicd-report.md
          echo "- Success Rate: $(gh api "/repos/${{ github.repository }}/actions/runs?status=completed&per_page=100" --jq '.workflow_runs[] | select(.conclusion == "success") | .id' | wc -l) / $(gh api "/repos/${{ github.repository }}/actions/runs?status=completed&per_page=100" --jq '.total_count')" >> cicd-report.md
          echo "- Recent Deployments: $(gh api "/repos/${{ github.repository }}/actions/workflows/production-deployment.yml/runs?per_page=100" --jq '.total_count')" >> cicd-report.md

      - name: Commit report to repository
        run: |
          REPORT_DATE=$(date -u '+%Y-%m-%d')
          REPORT_BRANCH="cicd-report-${REPORT_DATE}"

          mkdir -p reports
          mv cicd-report.md "reports/cicd-report-${REPORT_DATE}.md"

          if [ ! -f "reports/README.md" ]; then
            echo "# CI/CD Reports" > reports/README.md
            echo "" >> reports/README.md
            echo "This directory contains automated CI/CD reports and metrics." >> reports/README.md
            echo "" >> reports/README.md
            echo "## Available Reports" >> reports/README.md
            echo "" >> reports/README.md
          fi

          echo "- [${REPORT_DATE} CI/CD Report](./cicd-report-${REPORT_DATE}.md)" >> reports/README.md

      - name: Create Pull Request with report
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: cicd-report-$(date -u '+%Y-%m-%d')
          title: "CI/CD Report $(date -u '+%Y-%m-%d')"
          body: "Automated CI/CD metrics and pipeline health report"
          commit-message: "feat: add CI/CD report $(date -u '+%Y-%m-%d')"
          delete-branch: true
