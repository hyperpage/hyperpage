# Advanced Kubernetes Features for Enterprise Deployment
# Implements Phase 5: Service Mesh, Cost Optimization, and Advanced Security

---
# Pod Disruption Budget for High Availability
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: hyperpage-pdb
  labels:
    app: hyperpage
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: hyperpage
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: hyperpage-postgres-pdb
  labels:
    app: hyperpage
    component: postgres
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: hyperpage
      component: postgres

---
# Resource Quota for Cost Management
apiVersion: v1
kind: ResourceQuota
metadata:
  name: hyperpage-quota
  labels:
    app: hyperpage
spec:
  hard:
    requests.cpu: "2"
    requests.memory: 4Gi
    limits.cpu: "4"
    limits.memory: 8Gi
    persistentvolumeclaims: "4"
    requests.storage: 20Gi
    pods: "10"
    services: "10"
    configmaps: "10"
    secrets: "10"

---
# Limit Range for Resource Management
apiVersion: v1
kind: LimitRange
metadata:
  name: hyperpage-limits
  labels:
    app: hyperpage
spec:
  limits:
  - type: Container
    default:
      cpu: "500m"
      memory: "1Gi"
    defaultRequest:
      cpu: "100m"
      memory: "512Mi"
    max:
      cpu: "2"
      memory: "4Gi"
    min:
      cpu: "50m"
      memory: "128Mi"

---
# Priority Class for Critical Services
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: hyperpage-critical
  labels:
    app: hyperpage
value: 1000
globalDefault: false
description: "Priority class for Hyperpage critical components"
---
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: hyperpage-normal
  labels:
    app: hyperpage
value: 500
globalDefault: false
description: "Priority class for Hyperpage normal components"

---
# Advanced Security Policies
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hyperpage-strict-network-policy
  labels:
    app: hyperpage
    security: strict
spec:
  podSelector:
    matchLabels:
      app: hyperpage
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Only allow traffic from ingress controller and other hyperpage pods
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app: hyperpage
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 3000
      # Allow metrics scraping
    - protocol: TCP
      port: 9187
      
  egress:
  # Allow DNS, HTTPS to external APIs, and database connections
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 443
    # PostgreSQL connections
  - to:
    - podSelector:
        matchLabels:
          app: hyperpage
          component: postgres
    ports:
    - protocol: TCP
      port: 5432
    # Monitoring traffic
  - to:
    - namespaceSelector:
        matchLabels:
          name: monitoring

---
# Pod Security Standards
apiVersion: v1
kind: ConfigMap
metadata:
  name: hyperpage-security-config
  labels:
    app: hyperpage
    component: security
data:
  # Security context configuration
  security-policy.yaml: |
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: hyperpage-security-policy
      labels:
        app: hyperpage
    data:
      # Baseline security policy
      baseline.yaml: |
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: hyperpage-baseline-policy
        data:
          baseline.yaml: |
            apiVersion: policy/v1beta1
            kind: PodSecurityPolicy
            metadata:
              name: hyperpage-baseline
              labels:
                app: hyperpage
            spec:
              privileged: false
              allowPrivilegeEscalation: false
              requiredDropCapabilities:
                - ALL
              volumes:
                - 'configMap'
                - 'emptyDir'
                - 'projected'
                - 'secret'
                - 'downwardAPI'
                - 'persistentVolumeClaim'
              hostNetwork: false
              hostIPC: false
              hostPID: false
              runAsUser:
                rule: 'MustRunAsNonRoot'
              seLinux:
                rule: 'RunAsAny'
              fsGroup:
                rule: 'RunAsAny'

---
# Backup and Disaster Recovery
apiVersion: batch/v1
kind: CronJob
metadata:
  name: hyperpage-backup
  labels:
    app: hyperpage
    component: backup
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: postgres:18-alpine
            command:
            - /bin/sh
            - -c
            - |
              DATE=$(date +%Y%m%d_%H%M%S)
              BACKUP_DIR="/backups"
              
              # Create backup directory
              mkdir -p $BACKUP_DIR
              
              # Database backup
              pg_dump -h hyperpage-postgres -U postgres -d hyperpage > $BACKUP_DIR/hyperpage_$DATE.sql
              
              # Compress backup
              gzip $BACKUP_DIR/hyperpage_$DATE.sql
              
              # Upload to external storage (example with AWS S3)
              # aws s3 cp $BACKUP_DIR/hyperpage_$DATE.sql.gz s3://hyperpage-backups/
              
              # Clean old backups (keep 7 days)
              find $BACKUP_DIR -name "hyperpage_*.sql.gz" -mtime +7 -delete
              
              echo "Backup completed: hyperpage_$DATE.sql.gz"
            env:
            - name: POSTGRES_HOST
              value: "hyperpage-postgres"
            - name: POSTGRES_DB
              value: "hyperpage"
            - name: POSTGRES_USER
              value: "postgres"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: hyperpage-postgres-secrets
                  key: POSTGRES_PASSWORD
            volumeMounts:
            - name: backup-storage
              mountPath: /backups
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: hyperpage-backup-pvc
          restartPolicy: OnFailure
          serviceAccountName: hyperpage-backup-sa

---
# Service Account for Backup Operations
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hyperpage-backup-sa
  labels:
    app: hyperpage
    component: backup

---
# RBAC for Backup Service Account
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: hyperpage-backup-role
  labels:
    app: hyperpage
    component: backup
rules:
- apiGroups: [""]
  resources: ["pods", "secrets", "configmaps"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "create"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: hyperpage-backup-rolebinding
  labels:
    app: hyperpage
    component: backup
subjects:
- kind: ServiceAccount
  name: hyperpage-backup-sa
  namespace: default
roleRef:
  kind: Role
  name: hyperpage-backup-role
  apiGroup: rbac.authorization.k8s.io

---
# Backup Storage PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: hyperpage-backup-pvc
  labels:
    app: hyperpage
    component: backup
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: default

---
# Multi-Environment Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: hyperpage-env-config
  labels:
    app: hyperpage
    component: environment
data:
  # Development environment
  dev-config.yaml: |
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: hyperpage-dev-config
      labels:
        app: hyperpage
        environment: development
    data:
      NODE_ENV: "development"
      DEBUG: "true"
      LOG_LEVEL: "debug"
      DATABASE_URL: "file:./data/hyperpage_dev.db"
      RATE_LIMIT_REQUESTS_PER_HOUR: "10000"
      
  # Staging environment
  staging-config.yaml: |
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: hyperpage-staging-config
      labels:
        app: hyperpage
        environment: staging
    data:
      NODE_ENV: "staging"
      DEBUG: "false"
      LOG_LEVEL: "info"
      DATABASE_URL: "file:./data/hyperpage_staging.db"
      RATE_LIMIT_REQUESTS_PER_HOUR: "5000"
      
  # Production environment
  prod-config.yaml: |
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: hyperpage-prod-config
      labels:
        app: hyperpage
        environment: production
    data:
      NODE_ENV: "production"
      DEBUG: "false"
      LOG_LEVEL: "warn"
      DATABASE_URL: "postgresql://postgres:password@hyperpage-postgres:5432/hyperpage"
      RATE_LIMIT_REQUESTS_PER_HOUR: "1000"

---
# Environment-Specific Secrets Template
apiVersion: v1
kind: ConfigMap
metadata:
  name: hyperpage-secrets-template
  labels:
    app: hyperpage
    component: secrets-template
data:
  # Development secrets template
  dev-secrets-template.yaml: |
    apiVersion: v1
    kind: Secret
    metadata:
      name: hyperpage-dev-secrets
      labels:
        app: hyperpage
        environment: development
    type: Opaque
    stringData:
      NEXTAUTH_SECRET: "dev-secret-key-2025"
      DATABASE_URL: "file:./data/hyperpage_dev.db"
      
  # Staging secrets template
  staging-secrets-template.yaml: |
    apiVersion: v1
    kind: Secret
    metadata:
      name: hyperpage-staging-secrets
      labels:
        app: hyperpage
        environment: staging
    type: Opaque
    stringData:
      NEXTAUTH_SECRET: "staging-secret-key-2025"
      DATABASE_URL: "file:./data/hyperpage_staging.db"
      
  # Production secrets template
  prod-secrets-template.yaml: |
    apiVersion: v1
    kind: Secret
    metadata:
      name: hyperpage-prod-secrets
      labels:
        app: hyperpage
        environment: production
    type: Opaque
    stringData:
      NEXTAUTH_SECRET: "production-secret-key-2025-secure-64-char"
      DATABASE_URL: "postgresql://postgres:REPLACE_PASSWORD@hyperpage-postgres:5432/hyperpage"
      GITHUB_TOKEN: "REPLACE_WITH_PRODUCTION_TOKEN"
      JIRA_API_TOKEN: "REPLACE_WITH_PRODUCTION_TOKEN"
      GITLAB_TOKEN: "REPLACE_WITH_PRODUCTION_TOKEN"

---
# Container Registry Pull Secrets
apiVersion: v1
kind: Secret
metadata:
  name: hyperpage-registry-secret
  labels:
    app: hyperpage
    component: registry
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: BASE64_TOKEN

---
# Service Mesh Configuration (Istio)
apiVersion: v1
kind: ConfigMap
metadata:
  name: hyperpage-istio-config
  labels:
    app: hyperpage
    component: service-mesh
data:
  # Istio Virtual Service
  virtual-service.yaml: |
    apiVersion: networking.istio.io/v1beta1
    kind: VirtualService
    metadata:
      name: hyperpage-vs
      labels:
        app: hyperpage
    spec:
      hosts:
      - hyperpage.local
      - api.hyperpage.local
      gateways:
      - hyperpage-gateway
      http:
      - match:
        - uri:
            prefix: /
        route:
        - destination:
            host: hyperpage-service
            port:
              number: 80
        timeout: 30s
        retries:
          attempts: 3
          perTryTimeout: 10s
          
  # Istio Gateway
  gateway.yaml: |
    apiVersion: networking.istio.io/v1beta1
    kind: Gateway
    metadata:
      name: hyperpage-gateway
      labels:
        app: hyperpage
    spec:
      selector:
        istio: ingressgateway
      servers:
      - port:
          number: 80
          name: http
          protocol: HTTP
        hosts:
        - hyperpage.local
        - api.hyperpage.local
      - port:
          number: 443
          name: https
          protocol: HTTPS
        tls:
          mode: SIMPLE
          credentialName: hyperpage-tls-secret
        hosts:
        - hyperpage.local
        - api.hyperpage.local
          
  # Istio Destination Rule
  destination-rule.yaml: |
    apiVersion: networking.istio.io/v1beta1
    kind: DestinationRule
    metadata:
      name: hyperpage-dr
      labels:
        app: hyperpage
    spec:
      host: hyperpage-service
      trafficPolicy:
        loadBalancer:
          simple: LEAST_CONN
        connectionPool:
          tcp:
            maxConnections: 100
          http:
            http1MaxPendingRequests: 50
            maxRequestsPerConnection: 10
        circuitBreaker:
          consecutiveErrors: 3
          interval: 30s
          baseEjectionTime: 30s
      subsets:
      - name: v1
        labels:
          version: v1
          
  # Istio Peer Authentication
  peer-authentication.yaml: |
    apiVersion: security.istio.io/v1beta1
    kind: PeerAuthentication
    metadata:
      name: hyperpage-strict
      labels:
        app: hyperpage
    spec:
      mtls:
        mode: STRICT
          
  # Istio Authorization Policy
  authorization-policy.yaml: |
    apiVersion: security.istio.io/v1beta1
    kind: AuthorizationPolicy
    metadata:
      name: hyperpage-authz
      labels:
        app: hyperpage
    spec:
      selector:
        matchLabels:
          app: hyperpage
      rules:
      - from:
        - source:
            principals: ["cluster.local/ns/default/sa/hyperpage-service-account"]
        to:
        - operation:
            methods: ["GET", "POST", "PUT", "DELETE"]
      
# Advanced Monitoring and Alerting
apiVersion: v1
kind: ConfigMap
metadata:
  name: hyperpage-advanced-monitoring
  labels:
    app: hyperpage
    component: advanced-monitoring
data:
  # Custom Alert Rules
  advanced-alerts.yaml: |
    groups:
    - name: hyperpage.advanced
      interval: 30s
      rules:
      # Business Logic Monitoring
      - alert: HyperpageHighErrorRate
        expr: rate(hyperpage_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"
          
      # Database Performance
      - alert: PostgreSQLSlowQueries
        expr: pg_stat_activity_max_tx_duration > 300
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries detected"
          description: "Longest running query: {{ $value }} seconds"
          
      # Memory Leaks
      - alert: HyperpagePotentialMemoryLeak
        expr: rate(hyperpage_memory_usage_bytes[1h]) > 10000000  # 10MB/hour
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Potential memory leak detected"
          description: "Memory growth rate: {{ $value }} bytes/hour"
          
      # Custom Business Metrics
      - alert: HyperpageLowUserActivity
        expr: rate(hyperpage_user_actions_total[5m]) < 1
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Low user activity detected"
          description: "User activity rate: {{ $value }} actions/second"
          
  # Performance SLI/SLO Definitions
  sli-slo.yaml: |
    groups:
    - name: hyperpage.sli
      interval: 60s
      rules:
      # Availability SLO (99.9%)
      - record: hyperpage:availability_5m
        expr: |
          (
            (sum(rate(hyperpage_requests_total{status!~"5.."}[5m])) by (job)
            /
            sum(rate(hyperpage_requests_total[5m])) by (job)
          )
          
      # Latency SLO (P95 < 500ms)
      - record: hyperpage:latency_p95_5m
        expr: |
          histogram_quantile(0.95,
            sum(rate(hyperpage_request_duration_seconds_bucket[5m])) by (job, le)
          )
          
      # Error Rate SLO (< 1%)
      - record: hyperpage:error_rate_5m
        expr: |
          (
            sum(rate(hyperpage_requests_total{status=~"4.."}[5m])) by (job)
            /
            sum(rate(hyperpage_requests_total[5m])) by (job)
          )

---
# Cost Optimization and Resource Management
apiVersion: v1
kind: ConfigMap
metadata:
  name: hyperpage-cost-optimization
  labels:
    app: hyperpage
    component: cost-optimization
data:
  # Resource Optimization Recommendations
  optimization-guide.yaml: |
    # Cost Optimization Strategies for Hyperpage
    
    ## 1. Right-sizing Resources
    - Start with conservative limits (as defined in LimitRange)
    - Monitor actual usage for 1-2 weeks
    - Adjust HPA thresholds based on real metrics
    - Use node affinity for workload distribution
    
    ## 2. Storage Optimization
    - Use appropriate storage classes (SSD for database, HDD for backups)
    - Implement data retention policies
    - Regular cleanup of old backup files
    - Monitor PVC usage and resize as needed
    
    ## 3. Network Optimization
    - Enable compression for API responses
    - Use CDN for static assets
    - Implement efficient caching strategies
    - Monitor network usage and costs
    
    ## 4. Auto-scaling Optimization
    - Tune HPA stabilization windows
    - Use custom metrics for business-aware scaling
    - Implement scale-down policies
    - Monitor scaling patterns and costs
    
    ## 5. Multi-tenancy Benefits
    - Use namespaces for environment isolation
    - Resource quotas per environment
    - Shared monitoring infrastructure
    - Efficient resource utilization

---
# GitOps Configuration (ArgoCD)
apiVersion: v1
kind: ConfigMap
metadata:
  name: hyperpage-gitops-config
  labels:
    app: hyperpage
    component: gitops
data:
  # ArgoCD Application Definition
  argocd-application.yaml: |
    apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: hyperpage
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: https://github.com/your-org/hyperpage
        targetRevision: main
        path: k8s
        directory:
          recurse: true
      destination:
        server: https://kubernetes.default.svc
        namespace: hyperpage
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
        - CreateNamespace=true
        - PruneLast=true
      ignoreDifferences:
      - group: apps
        kind: Deployment
        jsonPointers:
        - /spec/template/spec/containers/0/image

---
# Final Deployment Validation
apiVersion: batch/v1
kind: Job
metadata:
  name: hyperpage-deployment-validation
  labels:
    app: hyperpage
    component: validation
spec:
  template:
    spec:
      containers:
      - name: validation
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          echo "Starting Hyperpage deployment validation..."
          
          # Wait for services to be ready
          echo "Waiting for hyperpage service..."
          kubectl wait --for=condition=available --timeout=300s deployment/hyperpage
          
          echo "Waiting for PostgreSQL service..."
          kubectl wait --for=condition=available --timeout=300s deployment/hyperpage-postgres
          
          # Test health endpoint
          echo "Testing health endpoint..."
          kubectl port-forward svc/hyperpage-service 8080:3000 &
          sleep 10
          
          if curl -f http://localhost:8080/api/health; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            exit 1
          fi
          
          # Test HPA
          echo "Testing HPA..."
          if kubectl get hpa hyperpage-hpa; then
            echo "âœ… HPA is configured"
          else
            echo "âŒ HPA not found"
            exit 1
          fi
          
          # Test monitoring
          echo "Testing monitoring..."
          if kubectl get servicemonitor hyperpage-monitor; then
            echo "âœ… ServiceMonitor is configured"
          else
            echo "âŒ ServiceMonitor not found"
            exit 1
          fi
          
          echo "ðŸŽ‰ All deployment validations passed!"
          
      restartPolicy: OnFailure
      serviceAccountName: hyperpage-service-account
  backoffLimit: 3
